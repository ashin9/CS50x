## [Volume](https://cs50.harvard.edu/x/2024/psets/4/volume/#volume)

复制头 : 知道头大小, 也不算大, 可以直接静态数组, 放在栈区处理

处理字节 : 重点在于理解 Buffer, 仅需两个字节, 挨个单元处理即可, 非常节省内存



为什么需要动态申请内存 ? 系统可以自动分配栈区内存, 为什么还需要手动分配堆区内存 ?

- 节省资源 : 内存贵, 用多少申请多少, 不需要了及时释放
- 存储大对象 : 栈区不是无限大, 对于大型项目所有变量都存放在栈区, 很可能不够用, 从而导致内存泄露
- 方便对象调用 : 对于大对象使用动态内存, 通过指针传递地址即可, 不用将整个对象都传递

什么时候需要动态申请内存 ?

- 代码量很大, 需要用大数据块来存储对象
- 程序用到大数组
- 数组长度根据程序变化
  - 数组缺点 : 声明必须指定长度, 且长度只能是常量, 不能是变量, 导致无法在函数运行过程中动态地扩充和缩小
  - 传统数组的问题, 其实就是静态内存的问题, 以前内存分配的缺陷, 所以动态内存变得重要
- 想让一个变量存储的内容不会因函数结束而被回收



## [Filter](https://cs50.harvard.edu/x/2024/psets/4/filter/less/#filter)

bitmap , 1bit 表示颜色, 只有黑白

图片格式支持 : 24bit (3 bytes, RGB 各 1byte) 等大小存颜色, 用 16 进制表示

文件只是以某种方式排列的位序列

metadata 元数据 : 文件头高度宽度等信息

内容 : 某种方式排列的位序列



BMP 文件头

- BITMAPFILEHEADER , 14 bytes
- BITMAPINFOHEADER , 40 bytes

BMP 文件体

- 3 bytes 三元组序列
- 有的顺序,有的逆序

想象成二维像素数组



b、g、r 和 s , 表示 模糊,灰度,反射和深褐色



灰度

- RGB 都为一样则为灰阶

- 取 RGB 平均值作为灰度, 表示深浅阶梯

sepia, 公式

reflect

- 每行遍历一半, 交换

blur

- 取 3 * 3方框内平均值



Edges

- Sobel operator, 索伯算子, 边缘检测, 运算图像亮度函数的梯度之近似值, 小且整数滤波器对图片在水平和垂直方向上做卷积
- 同 blur, 也是 3 * 3 方框计算, 不是取均值, 而是加权运算
- 边缘水平垂直都有, 计算 `Gx` `Gy`
  - 为什么内核有这些特定值？例如，在 Gx 方向上，我们将目标像素右侧的像素乘以正数，并将目标像素左侧的像素乘以负数。当我们求和时，如果右边的像素与左边的像素颜色相似，则结果将接近 0（数字抵消）。但是，如果右边的像素与左边的像素有很大不同，那么结果值将是非常正的或非常负的，这表明颜色的变化可能是对象之间边界的结果。类似的论点也适用于计算 y 方向的边。
  - 和值 : `Gx^2 + Gy^2` , 注意: 四舍五入, 上限 255
- 边缘处理 : 当成纯黑 0 0 0



## [Recover](https://cs50.harvard.edu/x/2024/psets/4/recover/#recover)

恢复被删除的图片数据

### JPEGs

- 前三字节是 : `0xff 0xd8 0xff`

- 第四字节以 `0xe`开头 即, 前四位为`1110` 

可能偶然遇到非 JPEG 的此种模式，因此数据恢复并非很精确准确

数码相机连续存储, 因此 JPEG 开头也表示上张图片的结尾

FAT 文件格式, 最小存储单位 512 bytes, 为一块，不足的对齐, 浪费的称为: `slack space`



迭代寻找签名, 每找到一个签名则打开新文件写入, 直到遇到第二个签名才停止写入和关闭文件

- 为了提高效率, 可以每次读 512 bytes 到缓冲区
- 块对齐, 每次检查每块（512bytes）的前四 bytes 即可

注意：

- JPEG 图片大小超过块大小
- 松弛空间默认初始化为 0，写到图片中也没关系



### 要求

- 一个命令行参数，指定源取证图像，其它参数则异常处理
- 若打不开取证图像则异常处理
- 提取的文件命名方式，xxx.jpg，从 000 开始计数
- 若使用 malloc，则不可泄露内存



清空测试输出 `rm -f *.jpg`

 

### 技巧

- 如何取字节前四位？`& 0xf0` 
- 如何处理 xxx.jpg？`sprintf(filename, "%03i,jpg", 2) `将格式化的数据写入字符串中，将结果存储到一个字符数组中
  - filename 为字符写入的变量
  - format 字符串，%03i 表示三数字整数
  - num，2 表示 %i 的替换
- 追加写入
- 若第一次不是特征？特殊处理
- 优化方向：循环内频繁打开关闭 IO，应该性能不高



